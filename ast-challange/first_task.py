import base64
import codecs
import re
from difflib import Differ

import gradio as gr

###from app.enable_pycdc import enable_pycdc
from app.generic_obfuscation_ast import deob

____ = None
_____ = None
______ = None

PT_START_DEOBF = """### Тестовая деобфускация для удобства стажёров.
### Удачи)))

import random, base64, codecs, zlib


pyobfuscate = ''
obfuscate = dict(map(lambda map, dict: (map, dict), ['(https://pyobfuscate.com)*(chr)'], ['5bk_QXR+t;VPpx$gs8F`FW-NtwMSCgBN&>2FXrf-?yWkH%sU&5ML%1}C8QKa@db3DhNlzrieU<A)?!<f96^19Y7U^`LM(FmgK0mVL+8??fX55Y>{E8!c{uUWeT2_3#VWik@w~tU)Vv!#bS51+--}ioErr5~NW4rOtbCp~5H}-u5CZkN!vp1JGynw4QI5HyIOraTVJ&bQz^ghsBWw6r{>9)Y(b?riiBCf<KkgtBHF`2J%yJeN$fya}vR$!!a*!D7jX0)hyDZ%QkD0ejOKU!zP+Kv&NifT(ud9sRzT^X!2l&;(reYh@B0*g3R$MGCH|s_sH7`L2MKYHgcYxB>p1RHd=ooII^bH<F?0jM4o*|~?jaEva;mMdl_6wP`-CP_y5oPUEj*5W=rcdm$#{$E#EN|1KJq>F3E?1-y;=Vq;+n2LU_Y1d@e+A{NURjVbZ4yQ1an2pJPIkev<}vzGDYtI=axPVzN|j~M|G!g0hlic?A0;e~C7q&V`W|oFeHI3aWmI{Vdqu6_B*NR`dTixDAjPQrte%uLn;Gcv!5R&{J<T}<Z5qf%e)U&Ims&-1`$$7$**tG<jl6`N#2^7)l(7S8g8ZtXoqQjm#=tQKiNw&x40<${PYl&jx9@AsmBP7fmDiKjc#_e~OhxogEb`RB$B|Yh{0a~NFrt~=tzn{)^MQ6wf|mCpMoYeq`W}%^czrUnJp}wCE4CUjYLE|hM+&GW^kMPkOoit*EWy`8a=gu9v}p3R!ZcPbUlRD>yutR@e(xcancO{|kwI&S)M6D^m3Eq-_?&RjqBIsQL{|VzF%h=4!cbKtv%PpQeZ5ywH7U=oo}(y6$E9ML#UIk=hBjn9P$0Hwi<`gJNN>>X#vNFR3>>}1!_96~4q8CH;is53z`i>x33%tRQ0N%1UJ%=5vb*~MLUO}a)ka{r0TN@o9?5*Ll1MieJH>QbI-}VuTe`)mMR^Z322cueec8={CO6a7H%Mo0MvZcnsfXCXM<S49o3Vd6j*;v0?6CO0d|5;NmomuwSVr5XU^3-$5WtU5g-OFxq!+_jfy4=XFf8!|#3#AF0W>j`HMD@iCrVP4nmbyAR7RGjzPjnbC|2bDw3(*ODKBmcy)<_SLpJ?e<RA`E`n|T1vI59h`9K<X=&<HTYrIabQV^|Fj8WWfgOM^hH6kJCs1lcG6gnl`vkXPzW`<+LXK1sEQWm@p$ss+j3K8iSw*-=LLI+(F`D@mVfa2jaFWL7JYmNhF_3?CYWUS>I{*?S(f{0FhcYkH*8E{24ezY?%>El7z<gzI`u<f~zXVm'.replace('\n', '')]))
_ = lambda OO00000OOO0000OOO, c_int=100000: (_OOOO00OO0O00O00OO := ''.join((chr(int(int(OO00000OOO0000OOO.split()[OO00O0OO00O0O0OO0]) / random.randint(1, c_int))) for OO00O0OO00O0O0OO0 in range(len(OO00000OOO0000OOO.split())))))
eval(''.join((chr(i) for i in [101, 120, 101, 99])))('setattr(__builtins__,"______",print);setattr(__builtins__,"_____",exec);setattr(__builtins__,"____",eval)')
__ = '979810 1451856 701556 1738286 1131928 777130 1808384 498944 2412960 956032 5915082 4357878 1155399 7076716 1096768 9607464 9704686 8048651 10662561 1351885 10886705 8237044 10331370 2165024 3365775 5799018 9212000 7813401 8233080 4307776 413344 10165379 4025860 4757856 496170 8060709 69960 5328081 7099189 6536544 7959920 2806214 277950 2559104 3012032 223936 591552 9962610 1436600 1625456 5192577 4043064 1416280 3080162 10471440 6462330 4343136 2861440 1741845 8975890 6851585 8140764 7802292 6122736 7539372 1359648 9536670 5335931 10511938 8937513 8056265 3637565 11016172 9717960 2552320 8763000 5587068 5512540 5299392 7436676 73124 10753765 8257920 1823360 9609948 4267890 564456 6065252 6855276 2748352 9834944 10534233 2795264 3236514 8647560 2677500 2522768 1586610 593434 616840 3060576 1538592 2229792 888544 595650 2166095 8397585 3274687 9948176 10319226 8029134 988668 6288620 1453785 2948200 3892980 10434410 4555166 9248990 1916577 3145315 3322534 5188572 7018320 5191305 5482508 3161360 3897952 174690 174590 5850618 2819556 3904427 2454325 9440720 9722790 10612894 2934736 1090686 1106370 8736540 964630 6486220 3989560 2202214 9069498 6645901 10245258 1684332 957682 544295 2842464 7583445 1981316 411517 194212 7295387 3013234 2510936 2828240 1167492 6193408 7805872 5476708 141792 5740225 5395508 4244946 2757725 9101568 10933439 7474074 8554518 4915482 1759329 898380 1844271 7482580 1039824 2242907 3913312 3144240 6702624 4845377 1374656 2064839 5705995 10300550 799434 9605960 8718120 1926528 1534284 2298665 414460 4306036 5724579 5008440 10100004 850660 8166980 6718020 7659663 1681362 488180 897888 756320 2823680 2456672 8309532 3951354 1671882 9611838 463904 1850592 3953815 1540586 1030624 5078241 2462680 8585512 2845632 2321235 355449 10672704 4871568 7530612 1852288 2691680 6459657 11642040 8839320 8637305 1195148 6157790 110976 6754401 10835875 3180288 4157867 10836840 795840 2778016 3047136 237664 18144 381174 4659978 1121877 9624264 2864672 986235 5340830 1642784 9477825 7475656 6378288 3466419 8494824 9749916 1930336 9773876 7674586 3866628 8029500 5434880 53218 2066016 6873517 2529885 2371328 9361876 4234930 1051952 9138354 1909910 4875025 4505490 3837832 8355225 438360 446368 1353568 2047008 2967488 10644804 4894212 7748136 703635 399743 7393907 3952600 3082911 5642000 5450960 7519200 4187848 1696630 5786256 5735665 169650 393313 3621538 3350704 1566824 2943433 7939188 4003881 967527 561064 990896 7872992 2789992 9179304 2780328 7594255 3794678 11010256 6994920 858864 2798948 2737895 5301632 4816300 2089555 9550224 8589846 8282736 710704 669460 1008320 4040180 4468458 4526055 3835186 3264666 1978960 11074200 9351688 2573086 423030 8277360 4632789 3426248 8649396 1341102 8535879 693289 70924 2222352 1938440 6407820 2503992 1014875 64400 4158814 6867432 11765640 7300228 896852 19830 396530 776928 1859904 1439168 67424 7429485 4829190 2985568 10064246 2184600 2413040 11045328 596428 793637 2391017 4416766 3764460 7478286 3906981 3338151 4907438 956510 1275136 83360 189056 859712 1119680 2407648 1855712 1930560 3580398 4905469 1308763 8720493 958750 2926374 703640 8119664 2026297 873341 410140 1330848 2057856 1774592 3048704 8564194 2723652 9627975 5140800 356544 8023440 8511960 1907960 8897280 1348550 2127408 4270610 2250839 5447652 4603434 8320689 4657918 1042434 877720 2696992 2977088 183296 458144 2275808 1242208 3007648 1647168 1716726 4057473 5110029 9255513 9648978 3760028 287880 1350832 576600 2926908 369780 135296 1752416 1471232 875008 417270 5899068 1957344 2283105 10560840 2661960 5444880 471852 155062 4971561 1012478 3930990 231442 192024 2492510 9757105 4498654 382150 671456 52192 192128 1092704 1805248 1929824 3051008 1404544 5733063 8413230 310532 4281784 47008 9891543 469728 6724580 7874240 123880 10211310 9466528 3691092 1031920 4662784 1366698 2876068 684728 1890876 5409383 87924 3339696 1271776 7161413 10515830 1596832 1374105 1571104 8689434 1980668 982940 695172 1856190 4762496 9664185 1719160 3392730 7284220 4214010 2232560 1050090 4511592 2763072 128617 414570 2823840 562016 3152448 2986944 9496020 617040 5896582 230571 3810280 10790754 11111184 4286945 10453520 94200 4224528 1214400 969445 1756234 1314192 9029097 3589970 7198400 915720 3425796 2037495 774890 1417344 1112032 2954944 2494880 751210 6317954 8358360 3763386 2488337 10677968 7769448 1700038 452600 1426976 2920480 1503808 1830496 4385723 11152920 2126353 4189185 1188120 3739320 8386524 3130596 56230 777830'
why, are, you, reading, this, thing, huh = ('____', 'in(chr(i) fo', '("".jo', 'r i in [101,120,', '101,99', '__))', ']))(_(')
b = 'eJxzLPfLigoMM47KDct2CvQwdXQPynEMrDAGAGNCB8A='
____(''.join((chr(int(OO00O0OO00O0O0OO00 / 2)) for OO00O0OO00O0O0OO00 in [202, 240, 202, 198] if _____ != ______)))(f""""____("".join(chr(i) for i in [101,120,101,99]))({____(base64.b64decode(codecs.decode('WlpaVaWuozEioF5mMJIxXS9sK18bLzSmMGL0YzV2ATEyL29xMFuwo2EyL3ZhMTIwo2EyXUcfnJVhMTIwo21jpzImpluvLKAyAwDhLwL0MTIwo2EyXTVcXF5xMJAiMTHbXFkjrJ9vMaImL2S0MF5do2yhXTAbpvucoaDbnF84XFxtMz9lVTxtnJ4tJmxkZvjtBQt4YPN5ZwtfVQZ5ZvjtAQN4KFxcYzIhL29xMFtcXFxcB2I4MJZbq2u5X3yiqFgupzHepzIuMTyhMlg0nTymX2u1nPg0nTyhMlx7pzShMT9gYaAyMJDbZFxvWlpa', ''.join((chr(int(i / 8)) for i in [912, 888, 928, 392, 408]))).encode()))})"""")

"""


def tokenize(text):
    # Split the text into words
    words = re.findall(r"\w+|\s+", text)
    tokens = []
    for word in words:
        if word.isspace():
            tokens.append((" ", " "))
        else:
            tokens.append((word, word))
    return tokens


def diff_texts(text1, text2):
    d = Differ()
    words1 = [t + "\n" for t in text1.split("\n")]
    words2 = [t + "\n" for t in text2.split("\n")]
    # Comparing the lists of words
    result = list(d.compare(words1, words2))

    # Formatting the output
    formatted_result = []
    for token in result:
        if token.startswith("- "):
            formatted_result.append((token[2:], "-"))
        elif token.startswith("+ "):
            formatted_result.append((token[2:], "+"))
        elif token.startswith("  "):
            formatted_result.append((token[2:], None))

    return formatted_result


def gradio_deob(source):
    ast_before, ast_after, unparse_before, unparse_after, deobfuscation_message = deob(
        source
    )
    diff = ""
    # diff = diff_texts(ast_before, ast_after)
    return diff, unparse_after, deobfuscation_message.value, ast_before, ast_after


def app():
    with gr.Blocks() as demo:
        code = gr.Code(
            lines=5, language="python", label="Input code", value=PT_START_DEOBF
        )
        greet_btn = gr.Button("Deobfuscate!")
        deobf_status = gr.Markdown("(deobfuscation status)")
        deobfed = gr.Code(language="python", label="AST Deobfed")
        with gr.Row():
            ast_before = gr.Code(language="python", label="AST before")
            ast_after = gr.Code(language="python", label="AST after")
        ast_transformation = gr.HighlightedText(
            label="AST Transformation",
            combine_adjacent=True,
            show_legend=True,
            color_map={"+": "green", "-": "red"},
        )
        greet_btn.click(
            fn=gradio_deob,
            inputs=code,
            outputs=[ast_transformation, deobfed, deobf_status, ast_before, ast_after],
            api_name="disassembly",
        )

    demo.launch(server_port=9999)


if __name__ == "__main__":
    #enable_pycdc()
    app()
